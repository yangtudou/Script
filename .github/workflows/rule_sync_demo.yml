name: è‡ªåŠ¨åŒ–ä¸‹è½½è§„åˆ™é›† demo

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  rule_sync:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: å®‰è£…å¿…è¦å·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: æ ¡éªŒ json æ•°æ®
        run: |
          if [[ ! -f ".github/rule_sync_list.json" ]]; then
            echo "âŒâŒ é…ç½®æ–‡ä»¶ rule_sync_list.json ä¸å­˜åœ¨"
            exit 1
          fi
          
          # éªŒè¯ JSON æ ¼å¼
          if ! jq empty .github/rule_sync_list.json 2>/dev/null; then
            echo "âŒâŒ é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯"
            exit 1
          fi
          
          echo "âœ… é…ç½®æ–‡ä»¶éªŒè¯é€šè¿‡"

      - name: åˆ›å»ºç›®å½•ç»“æ„
        run: |
          mkdir -p ClashMeta/{domain,ip}
          echo "ğŸ“ğŸ“ ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ"

      - name: å¹¶è¡Œä¸‹è½½è§„åˆ™æ–‡ä»¶
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          # æ ¸å¿ƒä¸‹è½½å‡½æ•°
          download_rule_file() {
            local group=$1 provider=$2 type=$3 base_url=$4 file_name=$5 description=$6
            
            local target_dir="ClashMeta/$type"
            local target_file="$target_dir/$file_name"
            local download_url="${base_url}${file_name}"
            
            echo "ğŸ”ğŸ” å¼€å§‹ä¸‹è½½: $description"
            echo "ä¸‹è½½URL: $download_url"
            echo "ç›®æ ‡æ–‡ä»¶: $target_file"
            
            # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
            mkdir -p "$target_dir"
            
            # ä¸‹è½½æ–‡ä»¶ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
            for i in {1..3}; do
              if curl -s -f -L \
                  -H "Authorization: token $GITHUB_TOKEN" \
                  -H "Accept: application/vnd.github.raw" \
                  "$download_url" -o "temp_download"; then
                
                # æ£€æŸ¥ä¸‹è½½çš„æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ
                if [[ ! -s "temp_download" ]]; then
                  echo "âš ï¸ ä¸‹è½½çš„æ–‡ä»¶ä¸ºç©º ($i/3): $file_name"
                  continue
                fi
                
                # å¤„ç†æ–‡ä»¶å¹¶æ·»åŠ å¤´éƒ¨ä¿¡æ¯
                BEIJING_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')
                {
                  echo "# ============================================================="
                  echo "# è§„åˆ™ç»„: $group"
                  echo "# æä¾›è€…: $provider"
                  echo "# ç±»å‹: $type"
                  echo "# æ–‡ä»¶: $file_name"
                  echo "# æè¿°: $description"
                  echo "# ä¸‹è½½åœ°å€: $download_url"
                  echo "# æ›´æ–°æ—¶é—´: $BEIJING_TIME (UTC+8)"
                  echo "# ============================================================="
                  echo ""
                  cat "temp_download"
                } > "$target_file"
                
                # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ
                if [[ -s "$target_file" ]]; then
                  echo "âœ… ä¸‹è½½æˆåŠŸ: $file_name ($(wc -l < "$target_file") è¡Œ)"
                  rm -f "temp_download"
                  return 0
                else
                  echo "âš ï¸ ç”Ÿæˆçš„æ–‡ä»¶ä¸ºç©º ($i/3): $file_name"
                fi
              else
                echo "âš ï¸ ä¸‹è½½å¤±è´¥ ($i/3): $file_name"
                sleep 2
              fi
            done
            
            echo "âŒâŒ æœ€ç»ˆä¸‹è½½å¤±è´¥: $file_name"
            return 1
          }

          export -f download_rule_file

          # ä½¿ç”¨ jq è§£æé…ç½®å¹¶ç”Ÿæˆä¸‹è½½å‘½ä»¤
          echo "å¼€å§‹è§£æé…ç½®æ–‡ä»¶..."
          jq -r '
            .rules_group.clash_meta | to_entries[] | 
            .key as $provider | 
            .value | to_entries[] | 
            .key as $type | 
            .value | 
            .base_url as $base_url | 
            .files[] | 
            "\($provider)|\($type)|\($base_url)|\(.name)|\(.description)"
          ' .github/rule_sync_list.json > download_list.txt
          
          echo "ç”Ÿæˆçš„ä¸‹è½½åˆ—è¡¨:"
          cat download_list.txt
          
          # å¤„ç†ä¸‹è½½
          while IFS='|' read -r provider type base_url name description; do
            echo "download_rule_file 'clash_meta' '$provider' '$type' '$base_url' '$name' '$description'"
          done < download_list.txt | xargs -I {} -P 4 bash -c "{}"
          
          echo "ä¸‹è½½ä»»åŠ¡å®Œæˆ"

      - name: éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
        run: |
          echo "=== æœ€ç»ˆæ–‡ä»¶éªŒè¯ ==="
          echo "åŸŸåè§„åˆ™æ–‡ä»¶:"
          ls -la ClashMeta/domain/ || echo "æ— åŸŸåè§„åˆ™æ–‡ä»¶"
          echo "IPè§„åˆ™æ–‡ä»¶:"
          ls -la ClashMeta/ip/ || echo "æ— IPè§„åˆ™æ–‡ä»¶"
          
          # æ£€æŸ¥æ–‡ä»¶å†…å®¹
          for file in ClashMeta/domain/*.yaml ClashMeta/ip/*.yaml 2>/dev/null; do
            if [[ -f "$file" ]]; then
              lines=$(wc -l < "$file")
              echo "æ–‡ä»¶: $(basename "$file") - $lines è¡Œ"
            fi
          done || echo "æ— æ–‡ä»¶å¯æ£€æŸ¥"

      - name: æäº¤å˜æ›´
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # è¯¦ç»†æ£€æŸ¥å˜æ›´
          echo "=== è¯¦ç»†å˜æ›´æ£€æŸ¥ ==="
          git status
          echo "=== æœªè·Ÿè¸ªæ–‡ä»¶ ==="
          git ls-files --others --exclude-standard | head -20 || echo "æ— æœªè·Ÿè¸ªæ–‡ä»¶"
          
          # å¼ºåˆ¶æ·»åŠ æ‰€æœ‰æ–‡ä»¶
          git add -A -f
          
          # å†æ¬¡æ£€æŸ¥çŠ¶æ€
          echo "=== æ·»åŠ åçš„çŠ¶æ€ ==="
          git status --short
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --cached --quiet; then
            echo "âŒâŒ ç¡®å®æ— å˜æ›´å¯æäº¤"
            echo "å¯èƒ½çš„åŸå› :"
            echo "1. æ–‡ä»¶æ²¡æœ‰æˆåŠŸä¸‹è½½"
            echo "2. æ–‡ä»¶å·²ç»å­˜åœ¨ä¸”å†…å®¹ç›¸åŒ"
            echo "3. Git é…ç½®é—®é¢˜"
            exit 0
          fi
          
          BEIJING_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')
          git commit -m "ğŸ”„ğŸ”„ğŸ”„ğŸ”„ è§„åˆ™åŒæ­¥ [$BEIJING_TIME UTC+8]" \
                     -m "åŸºäº .github/rule_sync_list.json è‡ªåŠ¨åŒæ­¥è§„åˆ™æ–‡ä»¶"
          
          echo "âœ… æäº¤æˆåŠŸï¼Œå‡†å¤‡æ¨é€..."
          
          # ä½¿ç”¨åˆå¹¶è€Œä¸æ˜¯ rebase
          for i in {1..3}; do
            if git fetch origin main && git merge --no-edit origin/main; then
              if git push origin main; then
                echo "âœ… å˜æ›´æäº¤æˆåŠŸ (ç¬¬ $i æ¬¡å°è¯•)"
                break
              else
                echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œé‡è¯•ä¸­... ($i/3)"
                sleep 2
              fi
            elif [[ $i -eq 3 ]]; then
              echo "âŒâŒâŒâŒ åˆå¹¶å¤±è´¥ï¼Œè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
              exit 1
            else
              echo "ğŸ”„ğŸ”„ğŸ”„ğŸ”„ åˆå¹¶å¤±è´¥ï¼Œé‡è¯•ä¸­... ($((i+1))/3)"
              sleep 3
            fi
          done