name: 自动化下载规则集 demo

on:
#  schedule:
#    - cron: '0 22 * * *'  # 北京时间早上 6:00
  workflow_dispatch:
#  push:
#    paths:
#      - '.github/rule_sync_list.json'  # 配置文件变更时触发

permissions:
  contents: write

jobs:
  rule_sync:
    runs-on: ubuntu-latest
    steps:
      - name: 检出当前仓库
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 1

      - name: 安装必要工具
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: 校验 json 数据
        run: |
          if [[ ! -f ".github/rule_sync_list.json" ]]; then
            echo "❌ 配置文件 rule_sync_list.json 不存在"
            exit 1
          fi
          
          # 验证 JSON 格式
          if ! jq empty .github/rule_sync_list.json 2>/dev/null; then
            echo "❌ 配置文件格式错误"
            exit 1
          fi
          
          echo "✅ 配置文件验证通过"

      - name: 创建目录结构
        run: |
          mkdir -p ClashMeta/{domain,ip}
          echo "📁 目录结构创建完成"

      - name: 并行下载规则文件
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          # 核心下载函数
          download_rule_file() {
            local group=$1 provider=$2 type=$3 base_url=$4 file_name=$5 description=$6
            
            local target_dir="ClashMeta/$type"
            local target_file="$target_dir/$file_name"
            local download_url="${base_url}${file_name}"
            
            echo "🔍 开始下载: $description"
            
            # 下载文件（带重试机制）
            for i in {1..3}; do
              if curl -s -f -L \
                  -H "Authorization: token $GITHUB_TOKEN" \
                  -H "Accept: application/vnd.github.raw" \
                  "$download_url" -o "temp_download"; then
                
                # 处理文件并添加头部信息
                BEIJING_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')
                {
                  echo "# ============================================================="
                  echo "# 规则组: $group"
                  echo "# 提供者: $provider"
                  echo "# 类型: $type"
                  echo "# 文件: $file_name"
                  echo "# 描述: $description"
                  echo "# 下载地址: $download_url"
                  echo "# 更新时间: $BEIJING_TIME (UTC+8)"
                  echo "# ============================================================="
                  echo ""
                  cat "temp_download"
                } > "$target_file"
                
                rm -f "temp_download"
                echo "✅ 下载成功: $file_name"
                return 0
              else
                echo "⚠️ 下载失败 ($i/3): $file_name"
                sleep 2
              fi
            done
            
            echo "❌ 最终下载失败: $file_name"
            return 1
          }

          # 导出函数以便并行使用
          export -f download_rule_file

          # 使用 jq 解析配置并生成下载命令
          jq -r '
            .rules_group.clash_meta | to_entries[] | 
            .key as $provider | 
            .value | to_entries[] | 
            .key as $type | 
            .value | 
            .base_url as $base_url | 
            .files[] | 
            "\($provider)|\($type)|\($base_url)|\(.name)|\(.description)"
          ' .github/rule_sync_list.json | while IFS='|' read -r provider type base_url name description; do
            echo "download_rule_file 'clash_meta' '$provider' '$type' '$base_url' '$name' '$description'"
          done | xargs -I {} -P 8 bash -c "{}"


      - name: 提交变更
        id: commit-changes
        run: |
          
          # 设置Git身份
          git config user.name "github-actions[Bot]"
          git config user.email "github-actions@users.noreply.github.com"
          
          # 添加所有变更
          git add -A
          
          # 检查是否有变更
          if git diff --cached --quiet; then
            echo "::notice::无变更可提交"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            # 获取北京时间
            BEIJING_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')
            
            # 提交变更
            git commit -m "🔄 规则更新 [$BEIJING_TIME UTC+8]"
            
            # 重试机制 (最多3次)
            for i in {1..3}; do
              if git pull --rebase origin Rules && git push origin Rules; then
                echo "::notice::变更已成功提交 (尝试次数: $i)"
                echo "has_changes=true" >> $GITHUB_OUTPUT
                break
              else
                echo "::warning::推送失败，重试中 ($i/3)..."
                sleep 2
              fi
            done
            
            # 检查最终状态
            if [ $i -eq 3 ]; then
              echo "::error::提交失败，重试次数用尽"
              exit 1
            fi
          fi