name: è‡ªåŠ¨åŒ–è§„åˆ™ä¸‹è½½ demo

on:
  schedule:
    - cron: '0 22 * * *'  # UTC 22:00 (åŒ—äº¬æ—¶é—´æ¬¡æ—¥ 6:00)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  rule_sync:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“
        uses: actions/checkout@v6
        with:
          path: rule_sync_temp
          ref: Rules
          fetch-depth: 1

      - name: æ£€å‡º MetaCubeX ä»“åº“
        uses: actions/checkout@v6
        with:
          repository: MetaCubeX/meta-rules-dat
          ref: meta
          path: meta-rules-dat
          sparse-checkout: |
            geo/geosite/geolocation-!cn.yaml
            geo/geosite/cn.yaml
            geo/geosite/google.yaml
            geo/geosite/telegram.yaml
            geo/geosite/github.yaml
            geo/geosite/apple.yaml
            geo/geosite/meta.yaml
            geo/geosite/private.yaml
            geo/geosite/cloudflare.yaml
            geo/geoip/cloudflare.yaml
            geo/geoip/cn.yaml
            geo/geoip/google.yaml
            geo/geoip/private.yaml
            geo/geoip/telegram.yaml
          sparse-checkout-concise: false  # âœ… ä¿®å¤ç‚¹1ï¼šå¿…é¡»è®¾ä¸ºfalse

      - name: æ£€å‡º AWAvenue ç§‹é£å¹¿å‘Šè§„åˆ™ä»“åº“
        uses: actions/checkout@v6
        with:
          repository: TG-Twilight/AWAvenue-Ads-Rule
          ref: main
          path: AWAvenue-Ads-Rule
          sparse-checkout: |
            Filters/AWAvenue-Ads-Rule-Clash.yaml
          sparse-checkout-concise: false  # âœ… ä¿®å¤ç‚¹2ï¼šå¿…é¡»è®¾ä¸ºfalse

      - name: å¤åˆ¶æ–‡ä»¶ï¼ˆå®‰å…¨ç‰ˆï¼‰
        run: |
          shopt -s nullglob  # âœ… ä¿®å¤ç‚¹3ï¼šè§£å†³é€šé…ç¬¦é—®é¢˜
          mkdir -p rule_sync_temp/ClashMeta/{domain,ip}
          cp -r meta-rules-dat/geo/geosite/* rule_sync_temp/ClashMeta/domain/
          cp -r meta-rules-dat/geo/geoip/* rule_sync_temp/ClashMeta/ip/
          cp -r AWAvenue-Ads-Rule/Filters/AWAvenue-Ads-Rule-Clash.yaml rule_sync_temp/ClashMeta/domain/AWAvenue-Ads-Rule-Clash.yaml

      - name: æäº¤å˜æ›´
        id: commit-changes
        run: |
          cd rule_sync_temp
          git config user.name "github-actions[Bot]"
          git config user.email "github-actions@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "::notice::æ— å˜æ›´å¯æäº¤"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            BEIJING_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')
            git commit -m "ğŸ”„ è§„åˆ™æ›´æ–° [$BEIJING_TIME UTC+8]"
            for i in {1..3}; do
              if git pull --rebase origin Rules && git push origin Rules; then
                echo "::notice::å˜æ›´å·²æˆåŠŸæäº¤ (å°è¯•æ¬¡æ•°: $i)"
                echo "has_changes=true" >> $GITHUB_OUTPUT
                break
              else
                echo "::warning::æ¨é€å¤±è´¥ï¼Œé‡è¯•ä¸­ ($i/3)..."
                sleep 2
              fi
            done
            if [ $i -eq 3 ]; then
              echo "::error::æäº¤å¤±è´¥ï¼Œé‡è¯•æ¬¡æ•°ç”¨å°½"
              exit 1
            fi