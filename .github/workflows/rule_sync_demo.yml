name: è‡ªåŠ¨åŒ–ä¸‹è½½è§„åˆ™é›† demo

on:
#  schedule:
#    - cron: '0 22 * * *'  # åŒ—äº¬æ—¶é—´æ—©ä¸Š 6:00
  workflow_dispatch:
#  push:
#    paths:
#      - '.github/rule_sync_list.json'  # é…ç½®æ–‡ä»¶å˜æ›´æ—¶è§¦å‘

permissions:
  contents: write

jobs:
  rule_sync:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          ref: Rules
          fetch-depth: 1

      - name: å®‰è£…å¿…è¦å·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: éªŒè¯é…ç½®æ–‡ä»¶
        run: |
          if [[ ! -f ".github/rule_sync_list.json" ]]; then
            echo "âŒ é…ç½®æ–‡ä»¶ rule_sync_list.json ä¸å­˜åœ¨"
            exit 1
          fi
          
          # éªŒè¯ JSON æ ¼å¼
          if ! jq empty rule_sync_list.json 2>/dev/null; then
            echo "âŒ é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯"
            exit 1
          fi
          
          echo "âœ… é…ç½®æ–‡ä»¶éªŒè¯é€šè¿‡"

      - name: åˆ›å»ºç›®å½•ç»“æ„
        run: |
          mkdir -p ClashMeta/{domain,ip}
          echo "ğŸ“ ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ"

      - name: å¹¶è¡Œä¸‹è½½è§„åˆ™æ–‡ä»¶
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          
          # æ ¸å¿ƒä¸‹è½½å‡½æ•°
          download_rule_file() {
            local group=$1 provider=$2 type=$3 base_url=$4 file_name=$5 description=$6
            
            local target_dir="ClashMeta/$type"
            local target_file="$target_dir/$file_name"
            local download_url="${base_url}${file_name}"
            
            echo "ğŸ” å¼€å§‹ä¸‹è½½: $description"
            
            # ä¸‹è½½æ–‡ä»¶ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
            for i in {1..3}; do
              if curl -s -f -L \
                  -H "Authorization: token $GITHUB_TOKEN" \
                  -H "Accept: application/vnd.github.raw" \
                  "$download_url" -o "temp_download"; then
                
                # å¤„ç†æ–‡ä»¶å¹¶æ·»åŠ å¤´éƒ¨ä¿¡æ¯
                BEIJING_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')
                {
                  echo "# ============================================================="
                  echo "# è§„åˆ™ç»„: $group"
                  echo "# æä¾›è€…: $provider"
                  echo "# ç±»å‹: $type"
                  echo "# æ–‡ä»¶: $file_name"
                  echo "# æè¿°: $description"
                  echo "# ä¸‹è½½åœ°å€: $download_url"
                  echo "# æ›´æ–°æ—¶é—´: $BEIJING_TIME (UTC+8)"
                  echo "# ============================================================="
                  echo ""
                  cat "temp_download"
                } > "$target_file"
                
                rm -f "temp_download"
                echo "âœ… ä¸‹è½½æˆåŠŸ: $file_name"
                return 0
              else
                echo "âš ï¸ ä¸‹è½½å¤±è´¥ ($i/3): $file_name"
                sleep 2
              fi
            done
            
            echo "âŒ æœ€ç»ˆä¸‹è½½å¤±è´¥: $file_name"
            return 1
          }

          # å¯¼å‡ºå‡½æ•°ä»¥ä¾¿å¹¶è¡Œä½¿ç”¨
          export -f download_rule_file

          # ä½¿ç”¨ jq è§£æé…ç½®å¹¶ç”Ÿæˆä¸‹è½½å‘½ä»¤
          jq -r '
            .rules_group.clash_meta | to_entries[] | 
            .key as $provider | 
            .value | to_entries[] | 
            .key as $type | 
            .value | 
            .base_url as $base_url | 
            .files[] | 
            "\($provider)|\($type)|\($base_url)|\(.name)|\(.description)"
          ' rule-config.json | while IFS='|' read -r provider type base_url name description; do
            echo "download_rule_file 'clash_meta' '$provider' '$type' '$base_url' '$name' '$description'"
          done | xargs -I {} -P 8 bash -c "{}"

      - name: ç”Ÿæˆä¸‹è½½æŠ¥å‘Š
        run: |
          BEIJING_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')
          cat > ClashMeta/README.md << EOF
          # ClashMeta è§„åˆ™æ–‡ä»¶
          
          æœ€åæ›´æ–°æ—¶é—´: $BEIJING_TIME (UTC+8)
          
          ## æ–‡ä»¶ç»Ÿè®¡
          - åŸŸåè§„åˆ™æ–‡ä»¶: \$(find ClashMeta/domain -name '*.yaml' | wc -l) ä¸ª
          - IPè§„åˆ™æ–‡ä»¶: \$(find ClashMeta/ip -name '*.yaml' | wc -l) ä¸ª
          - æ€»è®¡: \$(find ClashMeta -name '*.yaml' | wc -l) ä¸ª
          
          ## æ–‡ä»¶åˆ—è¡¨
          \`\`\`
          $(tree ClashMeta 2>/dev/null || find ClashMeta -type f | sort)
          \`\`\`
          
          ## é…ç½®ä¿¡æ¯
          æ­¤æ–‡ä»¶ç”±è‡ªåŠ¨åŒ–è§„åˆ™åŒæ­¥ç³»ç»Ÿç”Ÿæˆï¼Œé…ç½®æ–‡ä»¶: rule-config.json
          EOF
          
          echo "ğŸ“Š ä¸‹è½½æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: éªŒè¯ä¸‹è½½ç»“æœ
        run: |
          echo "ğŸ” æ–‡ä»¶å®Œæ•´æ€§æ£€æŸ¥:"
          total_files=0
          success_files=0
          
          for file in ClashMeta/domain/*.yaml ClashMeta/ip/*.yaml; do
            if [[ -f "$file" ]]; then
              ((total_files++))
              line_count=$(wc -l < "$file")
              if [[ $line_count -gt 5 ]]; then
                echo "âœ… $(basename "$file"): $line_count è¡Œ"
                ((success_files++))
              else
                echo "âŒ $(basename "$file"): å¯èƒ½æŸåï¼ˆåªæœ‰ $line_count è¡Œï¼‰"
              fi
            fi
          done
          
          echo "ğŸ“ˆ æˆåŠŸç‡: $success_files/$total_files"
          if [[ $success_files -eq $total_files ]]; then
            echo "ğŸ‰ æ‰€æœ‰æ–‡ä»¶ä¸‹è½½æˆåŠŸ"
          else
            echo "âš ï¸ éƒ¨åˆ†æ–‡ä»¶ä¸‹è½½å¤±è´¥"
          fi

      - name: æäº¤å˜æ›´
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet && git diff --staged --quiet; then
            echo "âœ… æ— å˜æ›´å¯æäº¤"
            exit 0
          fi
          
          BEIJING_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')
          git add -A
          git commit -m "ğŸ”„ è§„åˆ™åŒæ­¥ [$BEIJING_TIME UTC+8]" \
                     -m "åŸºäº rule-config.json è‡ªåŠ¨åŒæ­¥è§„åˆ™æ–‡ä»¶"
          
          # æ¨é€å˜æ›´ï¼ˆå¸¦é‡è¯•ï¼‰
          for i in {1..3}; do
            if git pull --rebase origin Rules && git push origin Rules; then
              echo "âœ… å˜æ›´æäº¤æˆåŠŸ (ç¬¬ $i æ¬¡å°è¯•)"
              break
            elif [[ $i -eq 3 ]]; then
              echo "âŒ æ¨é€å¤±è´¥ï¼Œè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
              exit 1
            else
              echo "ğŸ”„ æ¨é€å¤±è´¥ï¼Œé‡è¯•ä¸­... ($((i+1))/3)"
              sleep 3
            fi
          done