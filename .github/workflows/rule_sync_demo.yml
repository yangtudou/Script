name: è‡ªåŠ¨åŒ–ä¸‹è½½è§„åˆ™é›† demo

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  rule_sync:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          ref: main
          path: rules_sync_tmp
          fetch-depth: 1

      - name: å®‰è£…å¿…è¦å·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: æ ¡éªŒ json æ•°æ®
        run: |
          if [ ! -f "rules_sync_tmp/.github/rule_sync_list.json" ]; then
            echo "é…ç½®æ–‡ä»¶ rule_sync_list.json ä¸å­˜åœ¨"
            exit 1
          fi
          
          # éªŒè¯ JSON æ ¼å¼
          if ! jq empty rules_sync_tmp/.github/rule_sync_list.json 2>/dev/null; then
            echo "é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯"
            exit 1
          fi
          
          echo "::notice:: é…ç½®æ–‡ä»¶éªŒè¯é€šè¿‡"

      - name: åˆ›å»ºç›®å½•ç»“æ„
        run: |
          mkdir -p ClashMeta/{domain,ip}
          echo "ğŸ“ ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ"

      - name: å¹¶è¡Œä¸‹è½½è§„åˆ™æ–‡ä»¶
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          # æ ¸å¿ƒä¸‹è½½å‡½æ•°
          download_rule_file() {
            local group=$1 provider=$2 type=$3 base_url=$4 file_name=$5 description=$6
            
            local target_dir="ClashMeta/$type"
            local target_file="$target_dir/$file_name"
            local download_url="${base_url}${file_name}"
            
            echo "::notice:: å¼€å§‹ä¸‹è½½: $description"
            echo "ä¸‹è½½URL: $download_url"
            echo "ç›®æ ‡æ–‡ä»¶: $target_file"
            
            # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
            mkdir -p "$target_dir"
            
            # ä¸‹è½½æ–‡ä»¶ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
            for i in {1..3}; do
              if curl -s -f -L \
                  -H "Authorization: token $GITHUB_TOKEN" \
                  -H "Accept: application/vnd.github.raw" \
                  "$download_url" -o "temp_download"; then
                
                # æ£€æŸ¥ä¸‹è½½çš„æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ
                if [ ! -s "temp_download" ]; then
                  echo "âš ï¸ ä¸‹è½½çš„æ–‡ä»¶ä¸ºç©º ($i/3): $file_name"
                  continue
                fi
                
                # å¤„ç†æ–‡ä»¶å¹¶æ·»åŠ å¤´éƒ¨ä¿¡æ¯
                BEIJING_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')
                {
                  echo "# ============================================================="
                  echo "# $group è§„åˆ™"
                  echo "# æ¥æº: $provider"
                  echo "# ç±»å‹: $type"
                  echo "# åç§°: $file_name"
                  echo "# æè¿°: $description"
                  echo "# ä¸‹è½½åœ°å€: $download_url"
                  echo "# æ›´æ–°æ—¶é—´: $BEIJING_TIME (UTC+8)"
                  echo "# ============================================================="
                  echo ""
                  cat "temp_download"
                } > "$target_file"
                
                # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ
                if [ -s "$target_file" ]; then
                  echo "::notice:: ä¸‹è½½æˆåŠŸ: $file_name ($(wc -l < "$target_file") è¡Œ)"
                  rm -f "temp_download"
                  return 0
                else
                  echo "âš ï¸ ç”Ÿæˆçš„æ–‡ä»¶ä¸ºç©º ($i/3): $file_name"
                fi
              else
                echo "âš ï¸ ä¸‹è½½å¤±è´¥ ($i/3): $file_name"
                sleep 2
              fi
            done
            
            echo "âŒ æœ€ç»ˆä¸‹è½½å¤±è´¥: $file_name"
            return 1
          }

          export -f download_rule_file

          # ä½¿ç”¨ jq è§£æé…ç½®å¹¶ç”Ÿæˆä¸‹è½½å‘½ä»¤
          echo "å¼€å§‹è§£æé…ç½®æ–‡ä»¶..."
          jq -r '
            .rules_group.clash_meta | to_entries[] | 
            .key as $provider | 
            .value | to_entries[] | 
            .key as $type | 
            .value | 
            .base_url as $base_url | 
            .files[] | 
            "\($provider)|\($type)|\($base_url)|\(.name)|\(.description)"
          ' rules_sync_tmp/.github/rule_sync_list.json > rules_download_list.txt
          
          echo "ç”Ÿæˆçš„ä¸‹è½½åˆ—è¡¨:"
          cat rules_download_list.txt
          
          # å¤„ç†ä¸‹è½½
          while IFS='|' read -r provider type base_url name description; do
            echo "download_rule_file 'clash_meta' '$provider' '$type' '$base_url' '$name' '$description'"
          done < rules_download_list.txt | xargs -I {} -P 4 bash -c "{}"
          
          echo "ä¸‹è½½ä»»åŠ¡å®Œæˆ"

      - name: éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
        run: |
          echo "=== æœ€ç»ˆæ–‡ä»¶éªŒè¯ ==="
          echo "åŸŸåè§„åˆ™æ–‡ä»¶:"
          if [ -d "ClashMeta/domain" ]; then
            ls -la ClashMeta/domain/
          else
            echo "æ— åŸŸåè§„åˆ™æ–‡ä»¶"
          fi
          echo "IPè§„åˆ™æ–‡ä»¶:"
          if [ -d "ClashMeta/ip" ]; then
            ls -la ClashMeta/ip/
          else
            echo "æ— IPè§„åˆ™æ–‡ä»¶"
          fi
          
          # æ£€æŸ¥æ–‡ä»¶å†…å®¹
          if [ -d "ClashMeta/domain" ]; then
            for file in ClashMeta/domain/*.yaml; do
              if [ -f "$file" ]; then
                lines=$(wc -l < "$file" 2>/dev/null || echo 0)
                echo "æ–‡ä»¶: $(basename "$file") - $lines è¡Œ"
              fi
            done
          fi
          
          if [ -d "ClashMeta/ip" ]; then
            for file in ClashMeta/ip/*.yaml; do
              if [ -f "$file" ]; then
                lines=$(wc -l < "$file" 2>/dev/null || echo 0)
                echo "æ–‡ä»¶: $(basename "$file") - $lines è¡Œ"
              fi
            done
          fi

      - name: æ¨é€åˆ° Rules åˆ†æ”¯
        run: |

          cd rules_sync_tmp

          git status
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          
          
          # å†æ¬¡æ£€æŸ¥çŠ¶æ€
          echo "=== æ·»åŠ åçš„çŠ¶æ€ ==="
          git status
          
          git add ClashMeta/
          
          BEIJING_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')

          git commit -m "rules auto sync at [$BEIJING_TIME UTC+8]"
          
          echo "âœ… æäº¤æˆåŠŸï¼Œå‡†å¤‡æ¨é€è‡³ Rules åˆ†æ”¯"

          git push origin HEAD:Rules