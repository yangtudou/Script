name: 自动化下载规则集 demo

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  rule_sync:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4
        with:
          ref: main
          path: repo
          fetch-depth: 1

      - name: 安装依赖
        run: |
          sudo apt-get update && sudo apt-get install -y jq curl

      - name: 验证配置文件
        working-directory: repo
        run: |
          test -f ".github/rule_sync_list.json" || { echo "配置文件不存在"; exit 1; }
          jq empty .github/rule_sync_list.json || { echo "JSON 格式错误"; exit 1; }
          
          # 创建目录结构
          mkdir -p ClashMeta/{domain,ip}

      - name: 并行下载规则文件
        working-directory: repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 下载函数
          download_rule() {
            local provider="$1" type="$2" base_url="$3" name="$4" desc="$5"
            local dir="ClashMeta/$type" url="${base_url}${name}" temp_file="temp_$$"
            
            # 确保目录存在
            mkdir -p "$dir"
            
            # 下载（最多重试3次）
            for attempt in {1..3}; do
              if curl -sfL \
                  -H "Authorization: token $GITHUB_TOKEN" \
                  -H "Accept: application/vnd.github.raw" \
                  "$url" -o "$temp_file"; then
                
                if [ -s "$temp_file" ]; then
                  # 添加元数据头部
                  {
                    echo "# Rule: $desc"
                    echo "# Provider: $provider"
                    echo "# Type: $type"
                    echo "# Updated: $(date +'%Y-%m-%d %H:%M:%S' -u)"
                    echo "# Source: $url"
                    echo ""
                    cat "$temp_file"
                  } > "${dir}/${name}"
                  
                  echo "::notice:: 成功: $name ($(wc -l < "${dir}/${name}") 行)"
                  rm -f "$temp_file"
                  return 0
                fi
              fi
              
              echo "::warning:: 尝试 $attempt/3 失败: $name"
              sleep 2
            done
            
            echo "::error:: 下载失败: $name"
            return 1
          }
          
          export -f download_rule
          
          # 解析配置并下载
          jq -r '
            .rules_group.clash_meta | to_entries[] |
            .key as $provider |
            .value | to_entries[] |
            .key as $type |
            .value |
            .base_url as $base_url |
            .files[] |
            "\($provider)|\($type)|\($base_url)|\(.name)|\(.description)"
          ' .github/rule_sync_list.json | \
          while IFS='|' read -r provider type base_url name desc; do
            download_rule "$provider" "$type" "$base_url" "$name" "$desc" &
          done
          
          wait # 等待所有后台任务完成

      - name: 提交并推送至 Rules 分支
        working-directory: repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout Rules || git checkout -b Rules
          git add ClashMeta/
          
          if ! git diff --cached --quiet; then
            git commit -m "Auto sync rules - $(date +'%Y-%m-%d %H:%M')"
            git push origin Rules
            echo "✅ 规则已更新并推送到 Rules 分支"
          else
            echo "ℹ️ 没有变化需要提交"
          fi