name: Rule Sync

on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  rule_sync:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: æ£€å‡º MetaCubeX è§„åˆ™
        uses: actions/checkout@v4
        with:
          repository: MetaCubeX/meta-rules-dat
          ref: meta
          path: meta-rules-dat

      - name: æ£€å‡º AWAvenue å¹¿å‘Šè§„åˆ™
        uses: actions/checkout@v4
        with:
          repository: TG-Twilight/AWAvenue-Ads-Rule
          path: AWAvenue-Ads-Rule
          
      - name: å‡†å¤‡ç›®æ ‡ç›®å½•
        run: |
          mkdir -p ClashMeta/domain
          mkdir -p ClashMeta/ip
          
      - name: å¤„ç†è§„åˆ™æ–‡ä»¶
        run: |
          geosite_url="meta-rules-dat/geo/geosite"
          geoip_url="meta-rules-dat/geo/geoip"
          
          declare -a FILE_MAPPING=(
            "$geosite_url/geolocation-!cn.yaml domain/geolocation-!cn_domain.yaml domain MetaCubeX 'éä¸­å›½åŸŸåè§„åˆ™'"
            "$geosite_url/cn.yaml domain/cn_domain.yaml domain MetaCubeX 'ä¸­å›½åŸŸåè§„åˆ™'"
            "$geosite_url/google.yaml domain/google_domain.yaml domain MetaCubeX 'GoogleæœåŠ¡åŸŸåè§„åˆ™'"
            "$geosite_url/spotify.yaml domain/spotify_domain.yaml domain MetaCubeX 'SpotifyåŸŸåè§„åˆ™'"
            "$geosite_url/telegram.yaml domain/telegram_domain.yaml domain MetaCubeX 'TelegramåŸŸåè§„åˆ™'"
            "$geosite_url/youtube.yaml domain/youtube_domain.yaml domain MetaCubeX 'YouTubeåŸŸåè§„åˆ™'"
            "$geosite_url/github.yaml domain/github_domain.yaml domain MetaCubeX 'GitHubåŸŸåè§„åˆ™'"
            "$geosite_url/apple.yaml domain/apple_domain.yaml domain MetaCubeX 'AppleæœåŠ¡åŸŸåè§„åˆ™'"
            "$geosite_url/meta.yaml domain/meta_domain.yaml domain MetaCubeX 'MetaæœåŠ¡åŸŸåè§„åˆ™'"
            "$geosite_url/cloudflare.yaml domain/cloudflare_domain.yaml domain MetaCubeX 'CloudflareåŸŸåè§„åˆ™'"
            "$geosite_url/microsoft.yaml domain/microsoft_domain.yaml domain MetaCubeX 'MicrosoftåŸŸåè§„åˆ™'"
            "$geosite_url/private.yaml domain/private_domain.yaml domain MetaCubeX 'ç§æœ‰ç½‘ç»œåŸŸåè§„åˆ™'"
            "$geosite_url/speedtest.yaml domain/speedtest_domain.yaml domain MetaCubeX 'æµ‹é€ŸæœåŠ¡åŸŸåè§„åˆ™'"
            
            "$geoip_url/cloudflare.yaml ip/cloudflare_ip.yaml ip MetaCubeX 'Cloudflare IPè§„åˆ™'"
            "$geoip_url/cn.yaml ip/cn_ip.yaml ip MetaCubeX 'ä¸­å›½IPè§„åˆ™'"
            "$geoip_url/google.yaml ip/google_ip.yaml ip MetaCubeX 'GoogleæœåŠ¡IPè§„åˆ™'"
            "$geoip_url/private.yaml ip/private_ip.yaml ip MetaCubeX 'ç§æœ‰ç½‘ç»œIPè§„åˆ™'"
            "$geoip_url/telegram.yaml ip/telegram_ip.yaml ip MetaCubeX 'Telegram IPè§„åˆ™'"
            
            "AWAvenue-Ads-Rule/Filters/AWAvenue-Ads-Rule-Clash.yaml domain/AWAvenue-Ads-Rule-Clash.yaml domain AWAvenue 'å»å¹¿å‘Šè§„åˆ™'"
          )
          
          process_rule_file() {
            local src=$1 dest=$2 type=$3 source=$4 description=$5
            if [[ ! -f "$src" ]]; then
              echo "::warning::æ–‡ä»¶ä¸å­˜åœ¨: $src"
              return 1
            fi
            
            BEIJING_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')
            {
              echo "# ============================================================="
              echo "# æ¥æº: $source | æè¿°: $description"
              echo "# ç±»å‹: $type | æ›´æ–°æ—¶é—´: $BEIJING_TIME (UTC+8)"
              echo "# ============================================================="
              echo ""
              cat "$src"
            } > "ClashMeta/$dest"
            echo "âœ… å¤„ç†å®Œæˆ: $dest"
          }
          
          for mapping in "${FILE_MAPPING[@]}"; do
            eval "args=($mapping)"
            process_rule_file "${args[@]}" || continue
          done
          
          # éªŒè¯æ–‡ä»¶ç”Ÿæˆ
          echo "=== ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨ ==="
          find ClashMeta -type f -name "*.yaml" | sort
          
      - name: æäº¤å˜æ›´åˆ° Rules åˆ†æ”¯
        run: |
          # è®¾ç½®Gitèº«ä»½
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # åˆ‡æ¢åˆ° Rules åˆ†æ”¯
          git checkout -B Rules
          
          # æ¸…ç†æ—§æ–‡ä»¶
          rm -rf domain ip *.yaml 2>/dev/null || true
          
          # å¤åˆ¶æ–°æ–‡ä»¶ï¼ˆä½¿ç”¨æ›´å¯é çš„æ–¹æ³•ï¼‰
          echo "=== å¼€å§‹å¤åˆ¶æ–‡ä»¶ ==="
          if [ -d "ClashMeta" ]; then
            # åˆ†åˆ«å¤åˆ¶ç›®å½•å’Œæ–‡ä»¶
            [ -d "ClashMeta/domain" ] && cp -r ClashMeta/domain .
            [ -d "ClashMeta/ip" ] && cp -r ClashMeta/ip .
            
            # å¤åˆ¶æ ¹ç›®å½•ä¸‹çš„å…¶ä»–æ–‡ä»¶
            shopt -s dotglob
            cp -r ClashMeta/* . 2>/dev/null || true
          fi
          
          echo "=== å¤åˆ¶åçš„æ–‡ä»¶ç»“æ„ ==="
          ls -la
          [ -d "domain" ] && echo "domainç›®å½•:" && ls -la domain/
          [ -d "ip" ] && echo "ipç›®å½•:" && ls -la ip/
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
          git add -A
          
          # æ£€æŸ¥å˜æ›´
          if ! git diff --cached --quiet; then
            BEIJING_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')
            git commit -m "ğŸ”„ è§„åˆ™è‡ªåŠ¨æ›´æ–° [$BEIJING_TIME UTC+8]"
            git push origin Rules
            echo "âœ… æˆåŠŸæäº¤å˜æ›´åˆ° Rules åˆ†æ”¯"
          else
            echo "âŒ æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´"
            echo "è°ƒè¯•ä¿¡æ¯ï¼š"
            echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
            echo "æ–‡ä»¶çŠ¶æ€:"
            git status
            echo "æš‚å­˜åŒºå·®å¼‚:"
            git diff --cached --name-status
            exit 1
          fi
          
      - name: æ¸…ç†å·¥ä½œåŒº
        run: |
          rm -rf meta-rules-dat AWAvenue-Ads-Rule ClashMeta