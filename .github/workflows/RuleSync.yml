name: Rule Sync

on:
  schedule:
    - cron: '0 22 * * *'    # åŒ—äº¬æ—¶é—´æ—©ä¸Š 6:00
  workflow_dispatch:

permissions:
  contents: write

jobs:
  rule_sync:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºå½“å‰ä»“åº“ï¼ˆé»˜è®¤åˆ†æ”¯ï¼‰
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: æ£€å‡º MetaCubeX è§„åˆ™
        uses: actions/checkout@v4
        with:
          repository: MetaCubeX/meta-rules-dat
          ref: meta
          path: meta-rules-dat

      - name: æ£€å‡º AWAvenue å¹¿å‘Šè§„åˆ™
        uses: actions/checkout@v4
        with:
          repository: TG-Twilight/AWAvenue-Ads-Rule
          path: AWAvenue-Ads-Rule
          
      - name: å‡†å¤‡ç›®æ ‡ç›®å½•
        run: |
          mkdir -p ClashMeta/domain
          mkdir -p ClashMeta/ip
          
      - name: å¤„ç†è§„åˆ™æ–‡ä»¶
        run: |
          geosite_url="meta-rules-dat/geo/geosite"
          geoip_url="meta-rules-dat/geo/geoip"
          
          declare -a FILE_MAPPING=(
            "$geosite_url/geolocation-!cn.yaml domain/geolocation-!cn_domain.yaml domain MetaCubeX 'éä¸­å›½åŸŸåè§„åˆ™'"
            "$geosite_url/cn.yaml domain/cn_domain.yaml domain MetaCubeX 'ä¸­å›½åŸŸåè§„åˆ™'"
            "$geosite_url/google.yaml domain/google_domain.yaml domain MetaCubeX 'GoogleæœåŠ¡åŸŸåè§„åˆ™'"
            "$geosite_url/spotify.yaml domain/spotify_domain.yaml domain MetaCubeX 'SpotifyåŸŸåè§„åˆ™'"
            "$geosite_url/telegram.yaml domain/telegram_domain.yaml domain MetaCubeX 'TelegramåŸŸåè§„åˆ™'"
            "$geosite_url/youtube.yaml domain/youtube_domain.yaml domain MetaCubeX 'YouTubeåŸŸåè§„åˆ™'"
            "$geosite_url/github.yaml domain/github_domain.yaml domain MetaCubeX 'GitHubåŸŸåè§„åˆ™'"
            "$geosite_url/apple.yaml domain/apple_domain.yaml domain MetaCubeX 'AppleæœåŠ¡åŸŸåè§„åˆ™'"
            "$geosite_url/meta.yaml domain/meta_domain.yaml domain MetaCubeX 'MetaæœåŠ¡åŸŸåè§„åˆ™'"
            "$geosite_url/cloudflare.yaml domain/cloudflare_domain.yaml domain MetaCubeX 'CloudflareåŸŸåè§„åˆ™'"
            "$geosite_url/microsoft.yaml domain/microsoft_domain.yaml domain MetaCubeX 'MicrosoftåŸŸåè§„åˆ™'"
            "$geosite_url/private.yaml domain/private_domain.yaml domain MetaCubeX 'ç§æœ‰ç½‘ç»œåŸŸåè§„åˆ™'"
            "$geosite_url/speedtest.yaml domain/speedtest_domain.yaml domain MetaCubeX 'æµ‹é€ŸæœåŠ¡åŸŸåè§„åˆ™'"
            
            "$geoip_url/cloudflare.yaml ip/cloudflare_ip.yaml ip MetaCubeX 'Cloudflare IPè§„åˆ™'"
            "$geoip_url/cn.yaml ip/cn_ip.yaml ip MetaCubeX 'ä¸­å›½IPè§„åˆ™'"
            "$geoip_url/google.yaml ip/google_ip.yaml ip MetaCubeX 'GoogleæœåŠ¡IPè§„åˆ™'"
            "$geoip_url/private.yaml ip/private_ip.yaml ip MetaCubeX 'ç§æœ‰ç½‘ç»œIPè§„åˆ™'"
            "$geoip_url/telegram.yaml ip/telegram_ip.yaml ip MetaCubeX 'Telegram IPè§„åˆ™'"
            
            "AWAvenue-Ads-Rule/Filters/AWAvenue-Ads-Rule-Clash.yaml domain/AWAvenue-Ads-Rule-Clash.yaml domain AWAvenue 'å»å¹¿å‘Šè§„åˆ™'"
          )
          
          process_rule_file() {
            local src=$1 dest=$2 type=$3 source=$4 description=$5
            [[ ! -f "$src" ]] && { echo "::warning::æ–‡ä»¶ä¸å­˜åœ¨: $src"; return 1; }
            
            BEIJING_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')
            {
              echo "# ============================================================="
              echo "# æ¥æº: $source | æè¿°: $description"
              echo "# ç±»å‹: $type | æ›´æ–°æ—¶é—´: $BEIJING_TIME (UTC+8)"
              echo "# ============================================================="
              echo ""
              cat "$src"
            } > "ClashMeta/$dest"
            echo "âœ… å¤„ç†å®Œæˆ: $dest"
          }
          
          for mapping in "${FILE_MAPPING[@]}"; do
            IFS=' ' read -r -a args <<< "$mapping"
            process_rule_file "${args[@]}" || continue
          done
          
      - name: æäº¤å˜æ›´åˆ° Rules åˆ†æ”¯
        run: |
          # è®¾ç½®Gitèº«ä»½
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # åˆ‡æ¢åˆ° Rules åˆ†æ”¯ï¼ˆå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰
          git checkout -B Rules
          
          # å¤åˆ¶ç”Ÿæˆçš„æ–‡ä»¶åˆ°å½“å‰åˆ†æ”¯
          cp -r ClashMeta/* .
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet && git diff --staged --quiet; then
            echo "::notice::æ— å˜æ›´å¯æäº¤"
          else
            BEIJING_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')
            git add -A
            git commit -m "ğŸ”„ è§„åˆ™è‡ªåŠ¨æ›´æ–° [$BEIJING_TIME UTC+8]"
            
            # æ¨é€åˆ° Rules åˆ†æ”¯
            git push origin Rules
          fi
          
      - name: æ¸…ç†å·¥ä½œåŒº
        run: |
          rm -rf meta-rules-dat AWAvenue-Ads-Rule ClashMeta